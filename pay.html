<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Split ì •ì‚°ì„œ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #F2F4F6;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container { max-width: 500px; margin: 0 auto; }

        /* [ë¶€í™œ] ìƒë‹¨ í—¤ë” UI */
        .header-section {
            text-align: center;
            margin-bottom: 30px;
            padding-top: 20px;
        }
        .header-title { font-size: 22px; font-weight: 800; color: #191F28; margin-bottom: 8px; }
        .header-date { font-size: 14px; color: #8B95A1; margin-bottom: 16px; }
        .header-total-badge {
            display: inline-block;
            background-color: #E8F3FF;
            color: #3182F6;
            font-weight: 700;
            font-size: 18px;
            padding: 8px 16px;
            border-radius: 20px;
        }

        /* ì¹´ë“œ ë””ìì¸ */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .names { font-size: 17px; font-weight: 700; margin-bottom: 12px; color: #191F28; }
        
        /* [ê·¼ê±° ê°•í™”] ìƒì„¸ ë‚´ì—­ ìŠ¤íƒ€ì¼ */
        .detail-row {
            font-size: 13px;
            color: #6B7684;
            margin-bottom: 6px;
            display: flex;
            align-items: flex-start;
        }
        .detail-round {
            font-weight: 600;
            color: #333;
            margin-right: 6px;
            white-space: nowrap;
        }
        .detail-items { color: #8B95A1; word-break: keep-all; }

        /* ê¸ˆì•¡ ë° ë²„íŠ¼ */
        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #F2F4F6;
        }
        .price-info { display: flex; flex-direction: column; }
        .total-price { font-size: 20px; font-weight: 700; color: #3182F6; }
        .per-person { font-size: 12px; color: #8B95A1; margin-top: 4px; }
        
        .send-btn {
            background-color: #3182F6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }

        /* í•˜ë‹¨ ìƒì„¸ ë‚´ì—­ */
        .receipt-details { margin-top: 40px; padding-top: 20px; border-top: 1px dashed #C5C8CE; }
        .receipt-title { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 10px; }
        .receipt-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 6px; color: #666; }
        
        #loading { text-align: center; margin-top: 50px; font-size: 14px; color: #888; }
    </style>
</head>
<body>

<div class="container">
    <div id="loading">ì •ì‚°ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    
    <div id="content" style="display: none;">
        <div class="header-section">
            <div class="header-title" id="displayTitle">ëª¨ì„ ì´ë¦„</div>
            <div class="header-date" id="displayDate">2025.00.00</div>
            <div class="header-total-badge" id="displayTotal">0ì›</div>
        </div>

        <div id="card-list"></div>

        <div id="details-list" class="receipt-details"></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="js/firebase-config.js"></script>

<script>
    const db = initFirebase();
    db.settings({ experimentalForceLongPolling: true });

    const urlParams = new URLSearchParams(window.location.search);
    const docId = urlParams.get('id');

    if (!docId) {
        document.getElementById('loading').innerText = "ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.";
    } else {
        loadData(docId);
    }

    function loadData(id) {
        db.collection('receipts').doc(id).get().then((doc) => {
            if (doc.exists) {
                renderApp(doc.data());
            } else {
                document.getElementById('loading').innerText = "ì‚­ì œëœ ì •ì‚°ì„œì…ë‹ˆë‹¤.";
            }
        }).catch((error) => {
            document.getElementById('loading').innerText = "ì˜¤ë¥˜: " + error.message;
        });
    }

    function renderApp(data) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        // 1. [ë¶€í™œ] ìƒë‹¨ í—¤ë” ì •ë³´ ì±„ìš°ê¸°
        document.getElementById('displayTitle').innerText = data.title;
        document.getElementById('displayDate').innerText = data.date;
        document.getElementById('displayTotal').innerText = "ì´ " + data.total.toLocaleString() + "ì›";

        const cardContainer = document.getElementById('card-list');
        const detailContainer = document.getElementById('details-list');

        let groups = {};
        // ë©¤ë²„ë³„ "ìƒì„¸ ë‚´ì—­(ê·¼ê±°)"ë¥¼ ì €ì¥í•  ê°ì²´ (HTML íƒœê·¸ê°€ í¬í•¨ëœ ë¬¸ìì—´ ë°°ì—´)
        let memberEvidence = {}; 

        data.members.forEach(m => {
            let amt = m.amount;
            if(!groups[amt]) groups[amt] = [];
            groups[amt].push(m.name);

            // â˜… [ê·¼ê±° ê°•í™”] "ì™œ ì´ ê°€ê²©ì¸ê°€?" ë¡œì§ ìƒì„¸í™”
            let myEvidenceHtml = "";
            data.details.forEach((round, rIdx) => {
                let roundName = round.rName || (rIdx + 1) + "ì°¨";
                let totalItems = round.items.length;
                
                // ë‚´ê°€ ë¨¹ì€ ê²ƒë§Œ í•„í„°ë§
                let myItems = round.items.filter(item => !item.eaters || item.eaters.includes(m.name));

                if (myItems.length === 0) return; // ì•ˆ ë¨¹ì—ˆìœ¼ë©´ íŒ¨ìŠ¤

                let desc = "";
                if (myItems.length === totalItems) {
                    // ë‹¤ ë¨¹ìŒ -> ê¹”ë”í•˜ê²Œ
                    desc = "(ì „ì²´ í¬í•¨)";
                } else {
                    // ì¼ë¶€ë§Œ ë¨¹ìŒ -> ë¨¹ì€ ê²ƒ ë‚˜ì—´ (ê·¼ê±° ì œì‹œ)
                    let names = myItems.map(i => i.iName).join(", ");
                    desc = `(${names})`; // ì˜ˆ: (ë©œë¡ , ì†Œì£¼)
                }

                // í•œ ì¤„ì”© ìƒì„± (2ì°¨: ë©œë¡ , ì†Œì£¼)
                myEvidenceHtml += `
                    <div class="detail-row">
                        <span class="detail-round">${roundName}</span>
                        <span class="detail-items">${desc}</span>
                    </div>
                `;
            });
            memberEvidence[m.name] = myEvidenceHtml;
        });

        let sortedAmounts = Object.keys(groups).sort((a, b) => b - a);

        sortedAmounts.forEach(amt => {
            let members = groups[amt];
            let price = parseInt(amt);
            if (price === 0) return;

            let card = document.createElement('div');
            card.className = 'card';

            let namesHtml = members.join(', ');
            // ì²« ë²ˆì§¸ ì‚¬ëŒì˜ ë‚´ì—­ì„ ê°€ì ¸ì˜´ (ê°™ì€ ê¸ˆì•¡ ê·¸ë£¹ì´ë©´ ë‚´ì—­ë„ ê°™ë‹¤ê³  ê°€ì •)
            let evidenceHtml = memberEvidence[members[0]]; 

            let perPersonHtml = '';
            if (members.length > 1) {
                perPersonHtml = `<div class="per-person">${members.length}ëª… / 1ì¸ ${price.toLocaleString()}ì›</div>`;
            }

            let tossLink = `toss://send?amount=${price}&msg=${encodeURIComponent(data.title)}`;

            card.innerHTML = `
                <div class="names">${namesHtml}</div>
                <div style="margin-bottom: 12px;">
                    ${evidenceHtml}
                </div>
                <div class="price-row">
                    <div class="price-info">
                        <div class="total-price">${(price * members.length).toLocaleString()}ì›</div>
                        ${perPersonHtml}
                    </div>
                    <a href="${tossLink}" class="send-btn">ì†¡ê¸ˆ</a>
                </div>
            `;
            cardContainer.appendChild(card);
        });

        // í•˜ë‹¨ ì „ì²´ ë‚´ì—­ (ê¸°ì¡´ ë™ì¼)
        detailContainer.innerHTML = `<div class="receipt-title">ğŸ“‹ ì „ì²´ ì§€ì¶œ ìƒì„¸</div>`;
        data.details.forEach(r => {
            detailContainer.innerHTML += `<div style="font-weight:bold; margin-top:10px; font-size:13px;">${r.rName}</div>`;
            r.items.forEach(i => {
                detailContainer.innerHTML += `
                    <div class="receipt-row">
                        <span>- ${i.iName}</span>
                        <span>${i.price.toLocaleString()}ì›</span>
                    </div>`;
            });
        });
    }
</script>
</body>
</html>
