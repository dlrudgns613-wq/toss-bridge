<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Split ì •ì‚°ì„œ</title>
    <style>
        /* [ìŠ¤íƒ€ì¼ ëŒ€ê°œì¡°] ê¹”ë”í•˜ê³  ì§ê´€ì ì¸ í† ìŠ¤ ìŠ¤íƒ€ì¼ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #F2F4F6;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        /* ì¹´ë“œ ë””ìì¸ */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        /* ì´ë¦„ ì˜ì—­ */
        .names {
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #191F28;
            line-height: 1.4;
        }
        /* í•µì‹¬: ìƒì„¸ ë‚´ì—­ í…ìŠ¤íŠ¸ (íƒœê·¸ ëŒ€ì‹  ì‚¬ìš©) */
        .details-text {
            font-size: 13px;
            color: #8B95A1;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        .details-highlight {
            color: #4E5968; /* ë¨¹ì€ ë©”ë‰´ëŠ” ì¢€ ë” ì§„í•˜ê²Œ */
        }
        
        /* ê¸ˆì•¡ ì˜ì—­ */
        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 16px;
        }
        .price-info {
            display: flex;
            flex-direction: column;
        }
        .total-price {
            font-size: 20px;
            font-weight: 700;
            color: #3182F6;
        }
        /* "1ì¸ë‹¹ ì–¼ë§ˆ" */
        .per-person {
            font-size: 12px;
            color: #8B95A1;
            margin-top: 4px;
        }

        /* ë²„íŠ¼ ë‹¤ì´ì–´íŠ¸ */
        .send-btn {
            background-color: #3182F6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px; /* í¬ê¸° ì¤„ì„ */
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .send-btn:active { background-color: #1B64DA; }

        /* í•˜ë‹¨ ìƒì„¸ ë‚´ì—­ */
        .receipt-details {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px dashed #C5C8CE;
        }
        .receipt-title { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 10px; }
        .receipt-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 6px; color: #666; }
        
        /* ë¡œë”© */
        #loading { text-align: center; margin-top: 50px; font-size: 14px; color: #888; }
    </style>
</head>
<body>

<div class="container">
    <div id="loading">ì •ì‚° ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="content" style="display: none;">
        </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    // 1. íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì • (ë³¸ì¸ ì„¤ì •ìœ¼ë¡œ êµì²´ í•„ìˆ˜!)
    // ResultActivity.javaì—ì„œ ì¼ë˜ google-services.json ë‚´ìš© ì°¸ê³ 
    const firebaseConfig = {
        apiKey: "API_KEY_HERE",
        authDomain: "PROJECT_ID.firebaseapp.com",
        projectId: "PROJECT_ID",
        storageBucket: "PROJECT_ID.appspot.com",
        messagingSenderId: "SENDER_ID",
        appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2. URLì—ì„œ ID ê°€ì ¸ì˜¤ê¸° (?id= ë¬¸ì„œID)
    const urlParams = new URLSearchParams(window.location.search);
    const docId = urlParams.get('id');

    if (!docId) {
        document.getElementById('loading').innerText = "ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.";
    } else {
        loadData(docId);
    }

    function loadData(id) {
        db.collection('receipts').doc(id).get().then((doc) => {
            if (doc.exists) {
                renderApp(doc.data());
            } else {
                document.getElementById('loading').innerText = "ì‚­ì œë˜ê±°ë‚˜ ì—†ëŠ” ì •ì‚°ì„œì…ë‹ˆë‹¤.";
            }
        }).catch((error) => {
            console.error("Error:", error);
           document.getElementById('loading').innerText = "ì—ëŸ¬ ìƒì„¸: " + error.code + " / " + error.message;
        });
    }

    function renderApp(data) {
        document.getElementById('loading').style.display = 'none';
        const container = document.getElementById('content');
        container.style.display = 'block';

        // --- ë°ì´í„° ê°€ê³µ ë¡œì§ (í•µì‹¬) ---
        // ê¸ˆì•¡ë³„ë¡œ ì‚¬ëŒ ë¬¶ê¸° (Amount -> [Names])
        let groups = {};
        
        // ë©¤ë²„ë³„ ìƒì„¸ ë‚´ì—­ ë¶„ì„ ("ë¬´ì—‡ì„ ë¨¹ì—ˆë‚˜")
        let memberDetails = {}; // name -> string (ex: "1ì°¨(ì‚¼ê²¹ì‚´), 2ì°¨(ì½œë¼)")

        data.members.forEach(m => {
            // ê·¸ë£¹í•‘
            let amt = m.amount;
            if(!groups[amt]) groups[amt] = [];
            groups[amt].push(m.name);

            // â˜… ìƒì„¸ ë‚´ì—­ í…ìŠ¤íŠ¸ ìƒì„± ë¡œì§ (Problem 4 í•´ê²°)
            let myHistory = [];
            data.details.forEach((round, rIdx) => {
                let ateItems = [];
                let roundName = round.rName || (rIdx + 1) + "ì°¨";
                
                // ì´ ë¼ìš´ë“œì˜ ëª¨ë“  ë©”ë‰´ ì¤‘ ë‚´ê°€ ë¨¹ì€ ê²ƒ ì°¾ê¸° (DB êµ¬ì¡°ì— ë”°ë¼ ë‹¤ë¦„)
                // ë§Œì•½ eaters ì •ë³´ê°€ ì—†ë‹¤ë©´ Në¹µìœ¼ë¡œ ê°„ì£¼, ìˆë‹¤ë©´ ì²´í¬
                // *ê°„ë‹¨í™”ë¥¼ ìœ„í•´: ì´ ì‚¬ëŒì´ ë‚¸ ëˆì— ê¸°ì—¬í•œ í•­ëª© ì°¾ê¸°*
                // (ì •í™•í•œ eaters ë¡œì§ì´ ë³µì¡í•˜ë¯€ë¡œ, ì—¬ê¸°ì„  'ë¼ìš´ë“œ ì´ë¦„' ìœ„ì£¼ë¡œ í‘œì‹œí•˜ë˜
                // 'ì¼ë¶€'ì¸ ê²½ìš°ë¥¼ ê°ì§€í•˜ëŠ” ë¡œì§ì„ ì‹œë®¬ë ˆì´ì…˜ í•©ë‹ˆë‹¤.)
                
                // ì‹¤ì œë¡œëŠ” items ì•ˆì— eaters ë°°ì—´ì„ ë´ì•¼ í•¨. 
                // ì—¬ê¸°ì„œëŠ” UI ë¡œì§ë§Œ ì˜ˆì‹œë¡œ ë“­ë‹ˆë‹¤. 
                // ë§Œì•½ ë¼ìš´ë“œ ì „ì²´ Në¹µì´ë©´ -> "1ì°¨"
                // ë§Œì•½ ë¼ìš´ë“œ ì¤‘ ì¼ë¶€ë§Œ ë¨¹ì—ˆìœ¼ë©´ -> "2ì°¨(ì†Œì£¼, ë§¥ì£¼)"
                
                // (DBì— eaters ì •ë³´ê°€ ìˆë‹¤ê³  ê°€ì •)
                let totalItems = round.items.length;
                let myItems = round.items.filter(item => {
                    // eaters í•„ë“œê°€ ì—†ìœ¼ë©´ ì „ì²´ ì°¸ì—¬ë¡œ ê°„ì£¼, ìˆìœ¼ë©´ ë‚´ ì´ë¦„ í¬í•¨ ì—¬ë¶€ í™•ì¸
                    return !item.eaters || item.eaters.includes(m.name);
                });

                if (myItems.length === totalItems && totalItems > 0) {
                     myHistory.push(roundName); // ë‹¤ ë¨¹ìŒ -> ê¹”ë”í•˜ê²Œ ì°¨ìˆ˜ë§Œ
                } else if (myItems.length > 0) {
                    // ì¼ë¶€ë§Œ ë¨¹ìŒ -> ë©”ë‰´ ì´ë¦„ ë‚˜ì—´
                    let itemNames = myItems.map(i => i.iName);
                    let detailStr = itemNames[0];
                    if (itemNames.length > 1) detailStr += ` ì™¸ ${itemNames.length - 1}ê±´`;
                    myHistory.push(`${roundName}(${detailStr})`);
                }
            });
            memberDetails[m.name] = myHistory.join(", ");
        });

        // --- ë Œë”ë§ ---
        // ê¸ˆì•¡ í° ìˆœì„œëŒ€ë¡œ ì •ë ¬
        let sortedAmounts = Object.keys(groups).sort((a, b) => b - a);

        sortedAmounts.forEach(amt => {
            let members = groups[amt];
            let price = parseInt(amt);
            if (price === 0) return; // 0ì›ì€ í‘œì‹œ ì•ˆ í•¨

            // ì¹´ë“œ ìƒì„±
            let card = document.createElement('div');
            card.className = 'card';

            // ì´ë¦„
            let namesHtml = members.join(', ');
            
            // ì„¤ëª… (ì²« ë²ˆì§¸ ì‚¬ëŒ ê¸°ì¤€ìœ¼ë¡œ ì„¤ëª… ìƒì„± - ê°™ì€ ê¸ˆì•¡ì´ë©´ ë³´í†µ ê°™ì€ ê±° ë¨¹ìŒ)
            // "1ì°¨, 2ì°¨(ë©œë¡ ) í¬í•¨" ì²˜ëŸ¼ í‘œì‹œ
            let desc = memberDetails[members[0]]; 
            if(!desc) desc = "ì°¸ì—¬ ë‚´ì—­ ì—†ìŒ";

            // 1ì¸ë‹¹ ê¸ˆì•¡ ê³„ì‚°
            let perPersonHtml = '';
            if (members.length > 1) {
                perPersonHtml = `<div class="per-person">${members.length}ëª… / 1ì¸ ${price.toLocaleString()}ì›</div>`;
            }

            // í† ìŠ¤ ì†¡ê¸ˆ ë§í¬ (ë‹¨ì¼ ì†¡ê¸ˆì´ë©´ ê¸ˆì•¡ ê³ ì •, ì—¬ëŸ¬ëª…ì´ë©´ ê°ì ë³´ë‚¼ ê±°ë‹ˆê¹Œ 1ì¸ ê¸ˆì•¡)
            // í† ìŠ¤ í¬ë§·: toss://send?bank=ì€í–‰&accountNo=ê³„ì¢Œ&amount=ê¸ˆì•¡
            // ì£¼ì˜: ì›¹ì—ì„œëŠ” toss linkê°€ ì˜ ì•ˆë¨¹í ìˆ˜ ìˆìœ¼ë‹ˆ https í† ìŠ¤ ë§í¬ ì‚¬ìš© ê¶Œì¥
            // í˜¹ì€ ê·¸ëƒ¥ 'ì†¡ê¸ˆ' ë²„íŠ¼ë§Œ ë‘ 
            let tossLink = `toss://send?amount=${price}&msg=${encodeURIComponent(data.title)}`;

            card.innerHTML = `
                <div class="names">${namesHtml}</div>
                <div class="details-text">
                    <span class="details-highlight">ì°¸ì—¬:</span> ${desc}
                </div>
                <div class="price-row">
                    <div class="price-info">
                        <div class="total-price">${(price * members.length).toLocaleString()}ì›</div>
                        ${perPersonHtml}
                    </div>
                    <a href="${tossLink}" class="send-btn">ì†¡ê¸ˆ</a>
                </div>
            `;
            container.appendChild(card);
        });

        // í•˜ë‹¨ ì „ì²´ ìƒì„¸ ë‚´ì—­ (ì˜µì…˜)
        let detailsDiv = document.createElement('div');
        detailsDiv.className = 'receipt-details';
        detailsDiv.innerHTML = `<div class="receipt-title">ğŸ“‹ ì „ì²´ ìƒì„¸ ì§€ì¶œ ë‚´ì—­</div>`;
        
        data.details.forEach(r => {
            detailsDiv.innerHTML += `<div style="font-weight:bold; margin-top:10px; font-size:13px;">${r.rName}</div>`;
            r.items.forEach(i => {
                detailsDiv.innerHTML += `
                    <div class="receipt-row">
                        <span>- ${i.iName}</span>
                        <span>${i.price.toLocaleString()}ì›</span>
                    </div>`;
            });
        });
        container.appendChild(detailsDiv);
    }
</script>
</body>
</html>
