<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Smart Split Ï†ïÏÇ∞</title>
    <style>
        body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; background-color: #f2f4f6; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .receipt { background: white; width: 100%; max-width: 400px; padding: 30px 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h2 { margin: 0; color: #333; font-size: 20px; text-align: center; }
        .total-price { font-size: 36px; font-weight: bold; color: #3182f6; margin: 10px 0 10px 0; text-align: center; }
        .bank-box { background: #f9f9f9; padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 20px; color: #555; font-weight: 500; font-size: 15px; }
        .bank-box span { display: block; font-size: 13px; color: #888; margin-bottom: 5px; }
        .debug-info { font-size: 11px; color: #bbb; text-align: center; margin-bottom: 20px; } /* ÎîîÎ≤ÑÍ∑∏Ïö© */
        .section-title { font-size: 14px; color: #888; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .member-group { padding: 15px 0; border-bottom: 1px solid #f5f5f5; }
        .group-names { font-size: 16px; font-weight: 500; color: #333; margin-bottom: 5px; line-height: 1.4; }
        .group-amt-row { display: flex; justify-content: space-between; align-items: center; }
        .group-amt { font-size: 16px; font-weight: bold; color: #3182f6; }
        .toss-btn { font-size: 13px; color: #ffffff; background-color: #3182f6; padding: 6px 12px; border-radius: 8px; text-decoration: none; display: inline-block; }
        .details-container { margin-top: 30px; background: #fafafa; padding: 15px; border-radius: 12px; }
        .round-title { font-weight: bold; font-size: 15px; color: #333; margin-top: 15px; margin-bottom: 5px; }
        .round-title:first-child { margin-top: 0; }
        .item-row { display: flex; justify-content: space-between; font-size: 14px; color: #666; margin-bottom: 3px; }
        .footer { margin-top: 30px; font-size: 12px; color: #aaa; text-align: center; }
        .loading { text-align: center; color: #888; margin-top: 50px; }
    </style>
</head>
<body>

<div class="receipt">
    <h2 id="receipt-title">Î°úÎî© Ï§ë...</h2>
    <div class="total-price" id="receipt-total"></div>
    
    <div id="debug-area" class="debug-info"></div>

    <div id="bank-area" class="bank-box" style="display:none;">
        <span>ÏûÖÍ∏à Í≥ÑÏ¢å</span>
        <div id="bank-text"></div>
    </div>
    <div class="section-title">Î©§Î≤ÑÎ≥Ñ Ï†ïÏÇ∞ Í∏àÏï°</div>
    <div id="list-container">
        <div class="loading">ÎÇ¥Ïó≠ÏùÑ Î∂àÎü¨Ïò§Í≥† ÏûàÏäµÎãàÎã§...</div>
    </div>
    <div id="details-area" class="details-container" style="display:none;">
        <div class="section-title" style="border:none; padding:0; margin-bottom:10px;">üßæ ÏÉÅÏÑ∏ ÏßÄÏ∂ú ÎÇ¥Ïó≠</div>
        <div id="details-list"></div>
    </div>
    <div class="footer">Smart Split</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="./js/firebase-config.js"></script>

<script>
    const db = initFirebase(); 
    const params = new URLSearchParams(window.location.search);
    const docId = params.get('id');

    // 1. ÎßåÎä• ÏùÄÌñâ ÏΩîÎìú Ï∞æÍ∏∞
    function findBankCode(inputName) {
        if (!inputName) return "";
        const s = inputName.replace(/\s+/g, '').replace(/ÏùÄÌñâ/g, '').toLowerCase();
        
        // Ï£ºÏöî ÏùÄÌñâ ÏΩîÎìú Îß§Ìïë
        if (s.includes('ÎÜçÌòë') || s.includes('nh')) return "011";
        if (s.includes('Íµ≠ÎØº') || s.includes('kb')) return "004";
        if (s.includes('Ïπ¥Ïπ¥Ïò§') || s.includes('kakao') || s.includes('Ïπ¥Î±Ö')) return "090";
        if (s.includes('ÌÜ†Ïä§') || s.includes('toss')) return "092";
        if (s.includes('Ïã†Ìïú') || s.includes('Ï†úÏ£º')) return "088";
        if (s.includes('Ïö∞Î¶¨')) return "020";
        if (s.includes('Í∏∞ÏóÖ') || s.includes('ibk')) return "003";
        if (s.includes('ÌïòÎÇò') || s.includes('keb')) return "081";
        if (s.includes('ÏÉàÎßàÏùÑ') || s.includes('kfcc')) return "045";
        if (s.includes('Î∂ÄÏÇ∞')) return "032";
        if (s.includes('ÎåÄÍµ¨') || s.includes('im')) return "031";
        if (s.includes('ÏºÄÏù¥') || s.includes('kbank')) return "089";
        if (s.includes('Ïã†Ìòë')) return "048";
        if (s.includes('Ïö∞Ï≤¥Íµ≠')) return "071";
        if (s.includes('sc') || s.includes('Ï†úÏùº')) return "023";
        if (s.includes('Í¥ëÏ£º')) return "034";
        if (s.includes('Ï†ÑÎ∂Å')) return "037";
        if (s.includes('ÏàòÌòë')) return "007";
        if (s.includes('ÏÇ∞ÏóÖ')) return "002";
        return "";
    }

    // 2. Í≥ÑÏ¢åÎ≤àÌò∏ Ï∂îÏ∂ú
    function extractAccountNumber(fullText) {
        if (!fullText) return "";
        const match = fullText.match(/[0-9-]{10,}/);
        return match ? match[0].replace(/-/g, '') : "";
    }

    if (docId) {
        db.collection("receipts").doc(docId).get().then((doc) => {
            if (doc.exists) {
                renderReceipt(doc.data());
            } else {
                alert("ÏÇ≠Ï†úÎêú ÏòÅÏàòÏ¶ùÏûÖÎãàÎã§.");
            }
        });
    } else {
        document.getElementById('receipt-title').innerText = "ÏûòÎ™ªÎêú Ï†ëÍ∑º";
    }

    function renderReceipt(data) {
        document.getElementById('receipt-title').innerText = data.title;
        document.getElementById('receipt-total').innerText = Number(data.total).toLocaleString() + "Ïõê";

        let fullBankString = ""; 
        if (data.bank && data.bank.trim() !== "") {
            document.getElementById('bank-area').style.display = 'block';
            document.getElementById('bank-text').innerText = data.bank;
            fullBankString = data.bank;
        }

        // [ÏßÑÎã®] ÏµúÏ¢Ö Ïù∏ÏãùÎêú Í∞í ÌôïÏù∏
        let finalAccountNo = "";
        if (data.accountNumber && data.accountNumber.trim() !== "") {
            finalAccountNo = data.accountNumber.replace(/[^0-9]/g, '');
        } else {
            finalAccountNo = extractAccountNumber(fullBankString);
        }

        let finalBankCode = findBankCode(data.bankName || fullBankString);
        
        // ÌôîÎ©¥Ïóê ÏûëÍ≤å ÌëúÏãú (ÌÖåÏä§Ìä∏ ÌõÑ ÏßÄÏö∞ÏÖîÎèÑ Îê©ÎãàÎã§)
        document.getElementById('debug-area').innerText = `Ïù∏ÏãùÎêú ÏùÄÌñâ: ${finalBankCode} / Í≥ÑÏ¢å: ${finalAccountNo}`;

        const groups = {};
        data.members.forEach(member => {
            if (member.amount === 0) return;
            if (!groups[member.amount]) groups[member.amount] = [];
            groups[member.amount].push(member.name);
        });

        const sortedAmounts = Object.keys(groups).sort((a, b) => b - a);
        const container = document.getElementById('list-container');
        container.innerHTML = ""; 

        sortedAmounts.forEach(amount => {
            const memberNames = groups[amount];
            const namesText = memberNames.join(", ");
            // ‚òÖ 'Í∞Å' ÌëúÍ∏∞ Î°úÏßÅ (1Î™ÖÏù¥Î©¥ ÏÉùÎûµ)
            let priceLabel = memberNames.length > 1 ? "Í∞Å " + Number(amount).toLocaleString() + "Ïõê" : Number(amount).toLocaleString() + "Ïõê";

            // ‚òÖ‚òÖ‚òÖ [ÌïµÏã¨ ÏàòÏ†ï] URL Ïù∏ÏΩîÎî© Ï†ÅÏö© ‚òÖ‚òÖ‚òÖ
            // 1. msg(Ï†úÎ™©)Ïóê encodeURIComponent Ï†ÅÏö© -> ÎùÑÏñ¥Ïì∞Í∏∞ Î¨∏Ï†ú Ìï¥Í≤∞
            // 2. bankÏôÄ bankCode Îëò Îã§ Î≥¥ÎÉÑ -> ÌÜ†Ïä§ Î≤ÑÏ†Ñ Ìò∏ÌôòÏÑ± Ìï¥Í≤∞
            const safeTitle = encodeURIComponent(data.title); 
            const tossUrl = `supertoss://send?bank=${finalBankCode}&bankCode=${finalBankCode}&accountNo=${finalAccountNo}&amount=${amount}&msg=${safeTitle}`;

            const div = document.createElement('div');
            div.className = 'member-group';
            div.innerHTML = `
                <div class="group-names">${namesText}</div>
                <div class="group-amt-row">
                    <span class="group-amt">${priceLabel}</span>
                    <a href="${tossUrl}" class="toss-btn">ÏÜ°Í∏à ></a>
                </div>
            `;
            container.appendChild(div);
        });

        // ÏÉÅÏÑ∏ ÎÇ¥Ïó≠
        if (data.details && data.details.length > 0) {
            document.getElementById('details-area').style.display = 'block';
            const detailsList = document.getElementById('details-list');
            data.details.forEach(round => {
                const roundBox = document.createElement('div');
                roundBox.innerHTML = `<div class="round-title">üìç ${round.rName}</div>`;
                if(round.items) {
                    round.items.forEach(item => {
                        const row = document.createElement('div');
                        row.className = 'item-row';
                        row.innerHTML = `<span>- ${item.iName}</span><span>${Number(item.price).toLocaleString()}</span>`;
                        roundBox.appendChild(row);
                    });
                }
                detailsList.appendChild(roundBox);
            });
        }
    }
</script>

</body>
</html>
