<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>정산 영수증</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Inconsolata:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <style>
        body {
            background-color: #F0F2F5; /* 깔끔한 앱 배경색 */
            font-family: 'Noto Sans KR', sans-serif;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px 10px;
        }

        /* 영수증 카드 본체 */
        .receipt-card {
            background-color: #FFF;
            width: 100%;
            max-width: 400px;
            border-radius: 0 0 10px 10px; /* 위쪽은 톱니가 될 거라 둥글게 X */
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: relative;
            margin-top: 10px; /* 상단 톱니 공간 */
            padding-bottom: 30px;
        }

        /* ★ 상단 지그재그 (영수증 찢어진 느낌) */
        .receipt-card::before {
            content: "";
            position: absolute;
            top: -10px;
            left: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(135deg, transparent 33.333%, #FFF 33.333%, #FFF 66.667%, transparent 66.667%),
                        linear-gradient(45deg, transparent 33.333%, #FFF 33.333%, #FFF 66.667%, transparent 66.667%);
            background-size: 20px 20px;
            background-position: 0 10px; /* 방향 반대로 */
            transform: rotate(180deg); /* 뒤집어서 위로 */
        }
        
        /* 하단 지그재그 */
        .receipt-card::after {
            content: "";
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(45deg, transparent 33.333%, #FFF 33.333%, #FFF 66.667%, transparent 66.667%),
                        linear-gradient(-45deg, transparent 33.333%, #FFF 33.333%, #FFF 66.667%, transparent 66.667%);
            background-size: 20px 20px;
            background-position: 0 -10px;
        }

        .header-section {
            padding: 30px 25px 20px 25px;
            text-align: center;
            border-bottom: 2px dashed #EEE;
        }

        .meeting-title { font-size: 22px; font-weight: 700; color: #222; margin-bottom: 5px; }
        .meeting-date { font-size: 13px; color: #888; letter-spacing: 0.5px; }
        .total-amount { font-size: 28px; font-weight: 700; color: #3182f6; margin-top: 15px; font-family: 'Inconsolata', monospace; }

        .content-section {
            padding: 25px 20px;
        }

        /* ★ 그룹 카드 스타일 (개발자님이 원하신 회색 박스 느낌) */
        .group-card {
            border: 1px solid #EEE;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            background-color: #FAFAFA; /* 아주 연한 회색 배경 */
        }

        .group-names {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        /* ★ 태그 스타일 (회색 박스) */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
        }
        .tag {
            background-color: #E0E0E0;
            color: #555;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
        }
        /* 술 제외 같은 특이사항은 약간 다른 색으로 포인트 */
        .tag.special {
            background-color: #FFEBEE;
            color: #D32F2F;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 10px;
        }
        
        .price-detail {
            font-size: 12px;
            color: #888;
        }
        .price-per-person {
            font-size: 13px;
            color: #666;
            margin-bottom: 2px;
        }
        .price-final {
            font-size: 20px;
            font-weight: 700;
            color: #3182f6;
            font-family: 'Inconsolata', monospace;
        }

        /* ★ 송금 버튼 (작게 수정) */
        .btn-send {
            display: inline-block;
            background-color: #3182f6; /* 토스 블루 */
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 13px;
            font-weight: 700;
            margin-left: 10px;
            transition: background-color 0.2s;
        }
        .btn-send:active { background-color: #1b64da; }
        
        .footer { text-align: center; font-size: 11px; color: #CCC; margin-top: 30px; }
        .loading { text-align: center; padding: 50px; color: #999; font-size: 14px; }
    </style>
</head>
<body>

    <div class="receipt-card" id="receiptArea">
        <div class="loading">정산 내역을 불러오는 중...</div>
    </div>

    <script>
        const db = initFirebase();
        const urlParams = new URLSearchParams(window.location.search);
        const docId = urlParams.get('id');

        if (!docId) {
            document.getElementById('receiptArea').innerHTML = "<div class='loading'>잘못된 접근입니다.</div>";
        } else {
            loadReceipt(docId);
        }

        function loadReceipt(id) {
            db.collection("receipts").doc(id).get().then((doc) => {
                if (doc.exists) {
                    renderGroupedReceipt(doc.data());
                } else {
                    document.getElementById('receiptArea').innerHTML = "<div class='loading'>영수증을 찾을 수 없습니다.</div>";
                }
            }).catch((error) => {
                document.getElementById('receiptArea').innerHTML = "<div class='loading'>오류가 발생했습니다.</div>";
            });
        }

        function renderGroupedReceipt(data) {
            // 1. 그룹화 로직 (금액이 같은 사람끼리 묶기)
            let groups = {};
            data.members.forEach(member => {
                if (member.amount === 0) return;
                
                let amount = member.amount;
                if (!groups[amount]) {
                    groups[amount] = {
                        amount: amount,
                        members: [],
                        details: [] // 태그용 상세내역
                    };
                }
                groups[amount].members.push(member.name);
                
                // 태그 로직: 이 사람이 참여한 라운드 이름 찾기
                // (DB 구조상 details에 user별 참여 정보가 없다면, 전체 라운드를 기반으로 추정하거나
                // 단순히 '1차, 2차' 등의 포맷으로 표시)
                // 여기서는 "금액별로 태그가 다를 것이다"라는 가정 하에 표시
                
                // *중요*: 개발자님의 DB에 '누가 어디 참여했는지' 정보가 없다면 
                // 정확한 '술 제외' 태그 자동 생성은 어렵습니다.
                // 하지만 요청하신 예시 [1차][2차][3차(술 제외)] 느낌을 내기 위해
                // 모든 라운드 이름을 태그 후보로 둡니다.
            });

            // 렌더링 시작
            let html = `
                <div class="header-section">
                    <div class="meeting-title">${data.title}</div>
                    <div class="meeting-date">${data.date}</div>
                    <div class="total-amount">Total ₩ ${Number(data.total).toLocaleString()}</div>
                </div>
                <div class="content-section">
            `;

            // 그룹별 카드 생성
            // 금액 큰 순서대로 정렬
            let sortedAmounts = Object.keys(groups).sort((a, b) => b - a);

            sortedAmounts.forEach(amt => {
                let group = groups[amt];
                let names = group.members.join(", ");
                let count = group.members.length;
                let perPerson = Number(amt).toLocaleString();
                
                // ★ 태그 생성 로직 (여기를 커스텀하세요)
                // 예시: 5만원 이상이면 1,2,3차 다 간거고, 적으면 덜 간거라고 가정하고 태그를 다르게 줄 수도 있음.
                // 현재는 DB에 있는 '모든 라운드 이름'을 태그로 변환해서 보여주는 예시입니다.
                // (실제로는 참여한 라운드만 보여줘야 완벽하지만, 데이터 한계상 전체 라운드 표시)
                let tagsHtml = "";
                if (data.details && Array.isArray(data.details)) {
                    data.details.forEach((round, idx) => {
                        let tagName = round.rName || (idx + 1) + "차";
                        let tagClass = "tag";
                        
                        // "술"이나 "제외"라는 단어가 들어가면 빨간 태그로 (개발자님 요청 반영)
                        if(tagName.includes("제외") || tagName.includes("No")) {
                            tagClass += " special";
                        }
                        
                        // ※ 만약 금액이 낮은 그룹에는 '3차' 태그를 안 보여주고 싶다면?
                        // 여기에 if (amt < 평균) { continue; } 같은 로직 추가 가능
                        
                        tagsHtml += `<span class="${tagClass}">${tagName}</span>`;
                    });
                } else {
                     // details 데이터가 없을 경우 임시 태그
                     tagsHtml = `<span class="tag">정산 내역 확인</span>`;
                }

                // 토스 링크 (대표 1인 금액으로 생성)
                let bankParam = data.bankName ? `&bank=${data.bankName}` : "";
                let accountParam = data.accountNumber ? `&accountNo=${data.accountNumber}` : "";
                let tossLink = `supertoss://send?amount=${amt}${bankParam}${accountParam}`;

                html += `
                    <div class="group-card">
                        <div class="group-names">${names}</div>
                        
                        <div class="tags-container">
                            ${tagsHtml}
                        </div>
                        
                        <div class="price-row">
                            <div class="price-detail">
                                <div class="price-per-person">${count > 1 ? `1인 각 ${perPerson}원` : '정산 금액'}</div>
                            </div>
                            <div style="display:flex; align-items:center;">
                                <div class="price-final">₩ ${perPerson}</div>
                                <a href="${tossLink}" class="btn-send">송금</a>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                </div>
                <div class="footer">Smart Split</div>
            `;

            document.getElementById('receiptArea').innerHTML = html;
        }
    </script>
</body>
</html>
