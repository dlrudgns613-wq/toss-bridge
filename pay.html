<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>정산 상세 내역</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <style>
        body {
            background-color: #F2F4F6;
            font-family: 'Noto Sans KR', sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px 10px;
        }

        .container {
            width: 100%;
            max-width: 420px;
        }

        /* 1. 상단 요약 카드 (총액 & 계좌) */
        .summary-card {
            background-color: #FFF;
            border-radius: 16px;
            padding: 30px 24px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .meeting-title { font-size: 20px; font-weight: 700; color: #191F28; margin-bottom: 4px; }
        .meeting-date { font-size: 13px; color: #8B95A1; }
        .total-amount { font-size: 26px; font-weight: 700; color: #333D4B; margin-top: 16px; font-family: 'Roboto Mono', monospace; }

        .account-box {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #F9FAFB;
            padding: 10px 14px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 13px;
            color: #4E5968;
        }
        .btn-copy {
            background: none; border: 1px solid #D1D6DB; border-radius: 4px;
            padding: 2px 8px; margin-left: 8px; font-size: 11px; color: #4E5968; cursor: pointer;
        }

        /* 2. 개인별 정산 카드 (그룹) */
        .group-card {
            background-color: #FFF;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            border: 1px solid #F2F4F6;
        }

        .group-names { font-size: 16px; font-weight: 700; color: #191F28; margin-bottom: 10px; line-height: 1.4; }
        
        /* ★ 태그 스타일 (괄호 삭제, 깔끔한 박스) */
        .tags-container { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 14px; }
        .round-tag {
            background-color: #F2F4F6; color: #4E5968;
            font-size: 11px; padding: 4px 8px; border-radius: 4px; font-weight: 500;
        }
        /* '술 제외' 같은 키워드 있으면 색상 포인트 */
        .round-tag.special { background-color: #FFF0F0; color: #E94848; }

        .action-row { display: flex; justify-content: space-between; align-items: center; }
        
        /* "1인 각 17,920원" 통합 스타일 */
        .price-text { font-size: 14px; color: #333D4B; font-weight: 500; }
        .price-text strong { color: #3182F6; font-weight: 700; font-family: 'Roboto Mono', monospace; font-size: 17px; }

        .btn-send {
            background-color: #E8F3FF; color: #3182F6;
            padding: 7px 14px; border-radius: 6px; text-decoration: none;
            font-size: 13px; font-weight: 700;
        }

        /* 3. ★ 하단 상세 영수증 (부활!) */
        .receipt-detail-section {
            margin-top: 40px;
            background-color: #FFF;
            padding: 25px 20px;
            position: relative;
            /* 영수증 톱니바퀴 효과 */
            background-image: linear-gradient(135deg, #f2f4f6 25%, transparent 25%), linear-gradient(225deg, #f2f4f6 25%, transparent 25%);
            background-position: top center;
            background-size: 20px 20px;
            background-repeat: repeat-x;
            border-bottom: 2px dashed #EEE; /* 끝부분 느낌 */
            padding-top: 40px; /* 톱니 공간 확보 */
        }

        .detail-title { text-align: center; font-size: 14px; font-weight: 700; color: #888; margin-bottom: 20px; letter-spacing: 1px; }
        
        .receipt-list { font-size: 13px; color: #555; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dotted #EEE; padding-bottom: 4px; }
        .receipt-row.header { font-weight: bold; border-bottom: 2px solid #DDD; margin-bottom: 12px; color: #333; }
        .receipt-item-name { flex: 1; }
        .receipt-item-price { font-family: 'Roboto Mono', monospace; font-weight: 500; }

        .loading { text-align: center; padding: 60px; color: #8B95A1; font-size: 14px; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 10px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 13px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </script>
</head>
<body>

    <div class="container" id="receiptArea">
        <div class="loading">내역 불러오는 중...</div>
    </div>
    
    <div id="toast">계좌번호가 복사되었습니다.</div>

    <script>
        const db = initFirebase();
        const urlParams = new URLSearchParams(window.location.search);
        const docId = urlParams.get('id');

        if (docId) loadReceipt(docId);
        else document.getElementById('receiptArea').innerHTML = "<div class='loading'>잘못된 접근입니다.</div>";

        function loadReceipt(id) {
            db.collection("receipts").doc(id).get().then((doc) => {
                if (doc.exists) renderPage(doc.data());
                else document.getElementById('receiptArea').innerHTML = "<div class='loading'>내역이 없습니다.</div>";
            });
        }

        function renderPage(data) {
            // --- 1. 그룹화 로직 ---
            let groups = {};
            data.members.forEach(member => {
                if (member.amount === 0) return;
                let amt = member.amount;
                if (!groups[amt]) groups[amt] = { members: [] };
                groups[amt].members.push(member.name);
            });

            // --- 2. 태그 생성 로직 (피드백: 짧게, 괄호 없이) ---
            let tagsHtml = "";
            if (data.details && Array.isArray(data.details)) {
                data.details.forEach((round, idx) => {
                    // ★ 핵심 수정: "멜론 샐러드 외 3건" 삭제. 그냥 라운드 이름만 씀.
                    // 앱에서 "1차", "2차", "3차(술 제외)"라고 입력한 그 제목 그대로 가져옴.
                    // 뒤에 "비용" 같은 글자가 붙어있으면 제거 (개발자님 요청)
                    let title = round.rName || (idx + 1) + "차";
                    title = title.replace("비용", "").trim(); 
                    
                    let badgeClass = "round-tag";
                    // '제외' 키워드 있으면 빨간색 포인트
                    if(title.includes("제외") || title.includes("No")) badgeClass += " special";
                    
                    tagsHtml += `<span class="${badgeClass}">${title}</span>`;
                });
            }

            // --- 3. HTML 렌더링 ---
            let html = `
                <div class="summary-card">
                    <div class="meeting-title">${data.title}</div>
                    <div class="meeting-date">${data.date}</div>
                    <div class="total-amount">Total ₩${Number(data.total).toLocaleString()}</div>
                    
                    <div class="account-box">
                        <span>${data.bankName || "은행"} ${data.accountNumber || ""}</span>
                        <button class="btn-copy" onclick="copyAccount('${data.accountNumber}')">복사</button>
                    </div>
                </div>
            `;

            // 개인별(그룹별) 카드 리스트
            let sortedAmounts = Object.keys(groups).sort((a, b) => b - a);
            sortedAmounts.forEach(amt => {
                let group = groups[amt];
                let names = group.members.join(", ");
                let count = group.members.length;
                let perPerson = Number(amt).toLocaleString();
                
                // 토스 링크
                let bankParam = data.bankName ? `&bank=${data.bankName}` : "";
                let accountParam = data.accountNumber ? `&accountNo=${data.accountNumber}` : "";
                let tossLink = `supertoss://send?amount=${amt}${bankParam}${accountParam}`;

                html += `
                    <div class="group-card">
                        <div class="group-names">${names} <span style="font-weight:400; font-size:13px; color:#888;">(${count}명)</span></div>
                        
                        <div class="tags-container">${tagsHtml}</div>
                        
                        <div class="action-row">
                            <div class="price-text">1인 각 <strong>${perPerson}원</strong></div>
                            <a href="${tossLink}" class="btn-send">송금</a>
                        </div>
                    </div>
                `;
            });

            // --- 4. ★ 상세 영수증 (부활!!) ---
            html += `
                <div class="receipt-detail-section">
                    <div class="detail-title">─── 상세 내역 (RECEIPT) ───</div>
                    <div class="receipt-list">
                        <div class="receipt-row header">
                            <span class="receipt-item-name">품명</span>
                            <span class="receipt-item-price">금액</span>
                        </div>
            `;
            
            // 상세 품목 리스트업
            if (data.details && Array.isArray(data.details)) {
                data.details.forEach(round => {
                    // 라운드 구분선
                    html += `<div style="margin:15px 0 5px 0; font-weight:bold; color:#333;">[ ${round.rName || '차수'} ]</div>`;
                    
                    if(round.items && Array.isArray(round.items)) {
                        round.items.forEach(item => {
                            html += `
                                <div class="receipt-row">
                                    <span class="receipt-item-name">${item.iName || item.name}</span>
                                    <span class="receipt-item-price">${Number(item.price).toLocaleString()}</span>
                                </div>
                            `;
                        });
                    }
                });
            }

            html += `
                    </div>
                    <div style="text-align:center; margin-top:30px; font-size:11px; color:#AAA;">
                        위 내역을 확인 후 정산해주세요.<br>Smart Split
                    </div>
                </div>
            `;

            document.getElementById('receiptArea').innerHTML = html;
        }

        function copyAccount(acc) {
            if(!acc) return;
            navigator.clipboard.writeText(acc).then(() => {
                let x = document.getElementById("toast");
                x.className = "show";
                setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
            });
        }
    </script>
</body>
</html>
