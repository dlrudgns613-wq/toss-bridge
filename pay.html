<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Split ì •ì‚°ì„œ</title>
    <style>
        /* [UI ê°œì„ ] í† ìŠ¤/ì¹´ì¹´ì˜¤í˜ì´ ìŠ¤íƒ€ì¼ì˜ ê¹”ë”í•œ ë””ìì¸ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #F2F4F6;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container { max-width: 500px; margin: 0 auto; }
        
        /* ì¹´ë“œ ë””ìì¸ */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        /* ì´ë¦„ ì˜ì—­ */
        .names {
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #191F28;
            line-height: 1.4;
        }
        
        /* [ìˆ˜ì •] ìƒì„¸ ë‚´ì—­ í…ìŠ¤íŠ¸ (ì§€ì €ë¶„í•œ íƒœê·¸ ì‚­ì œ) */
        .details-text {
            font-size: 13px;
            color: #8B95A1;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        .details-highlight { color: #4E5968; font-weight: 600; }
        
        /* ê¸ˆì•¡ ì˜ì—­ */
        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 16px;
        }
        .price-info { display: flex; flex-direction: column; }
        .total-price {
            font-size: 20px;
            font-weight: 700;
            color: #3182F6;
        }
        /* [ì¶”ê°€] 1ì¸ë‹¹ ê¸ˆì•¡ í‘œì‹œ */
        .per-person {
            font-size: 12px;
            color: #8B95A1;
            margin-top: 4px;
        }

        /* [ìˆ˜ì •] ë²„íŠ¼ ë””ìì¸ ë‹¤ì´ì–´íŠ¸ */
        .send-btn {
            background-color: #3182F6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px; /* í¬ê¸° ì¤„ì„ */
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .send-btn:active { background-color: #1B64DA; }

        /* í•˜ë‹¨ ìƒì„¸ ë‚´ì—­ */
        .receipt-details {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px dashed #C5C8CE;
        }
        .receipt-title { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 10px; }
        .receipt-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 6px; color: #666; }
        
        #loading { text-align: center; margin-top: 50px; font-size: 14px; color: #888; }
    </style>
</head>
<body>

<div class="container">
    <div id="loading">ì •ì‚° ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="content" style="display: none;"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
    // [ì¤‘ìš”] ê°œë°œìë‹˜ì´ ë”°ë¡œ ë¹¼ë‘ì‹  API í‚¤ ì„¤ì • ì½”ë“œê°€ ìˆë‹¤ë©´ ì´ ë¶€ë¶„ì„ ì§€ìš°ì§€ ë§ê³  ìœ ì§€í•˜ì„¸ìš”!
    // ë§Œì•½ ì•„ë˜ ì½”ë“œê°€ ì—†ë‹¤ë©´, ê¸°ì¡´ì— ì“°ì‹œë˜ firebaseConfig ì„¤ì •ì„ ì—¬ê¸°ì— ë„£ìœ¼ì‹œë©´ ë©ë‹ˆë‹¤.
    // ------------------------------------------------------------------
    // const firebaseConfig = { ... };
    // firebase.initializeApp(firebaseConfig);
    // ------------------------------------------------------------------
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    // Firestore ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸° (ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆë‹¤ê³  ê°€ì •)
    const db = firebase.firestore();

    // URL íŒŒì‹± ë° ë°ì´í„° ë¡œë“œ ì‹œì‘
    const urlParams = new URLSearchParams(window.location.search);
    const docId = urlParams.get('id');

    if (!docId) {
        document.getElementById('loading').innerText = "ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.";
    } else {
        loadData(docId);
    }

    function loadData(id) {
        db.collection('receipts').doc(id).get().then((doc) => {
            if (doc.exists) {
                renderApp(doc.data());
            } else {
                document.getElementById('loading').innerText = "ì‚­ì œë˜ê±°ë‚˜ ì—†ëŠ” ì •ì‚°ì„œì…ë‹ˆë‹¤.";
            }
        }).catch((error) => {
            console.error("Error:", error);
            // ì—ëŸ¬ ì‹œ ì½”ë“œì™€ ë©”ì‹œì§€ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
            document.getElementById('loading').innerText = "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + error.code;
        });
    }

    // â˜… [í•µì‹¬] UI ë Œë”ë§ ë¡œì§ (2ì°¨(ì¼ë¶€) ë¬¸ì œ í•´ê²°ë¨)
    function renderApp(data) {
        document.getElementById('loading').style.display = 'none';
        const container = document.getElementById('content');
        container.style.display = 'block';

        let groups = {};
        let memberDetails = {}; 

        data.members.forEach(m => {
            // 1. ê¸ˆì•¡ë³„ ê·¸ë£¹í•‘
            let amt = m.amount;
            if(!groups[amt]) groups[amt] = [];
            groups[amt].push(m.name);

            // 2. ìƒì„¸ ë‚´ì—­ í…ìŠ¤íŠ¸ ìƒì„± ("2ì°¨(ë©œë¡ )" í˜•íƒœë¡œ ë³€í™˜)
            let myHistory = [];
            data.details.forEach((round, rIdx) => {
                let roundName = round.rName || (rIdx + 1) + "ì°¨";
                
                // ë‚´ê°€ ë¨¹ì€ í•­ëª© í•„í„°ë§
                let totalItems = round.items.length;
                let myItems = round.items.filter(item => {
                    return !item.eaters || item.eaters.includes(m.name);
                });

                if (myItems.length === totalItems && totalItems > 0) {
                     myHistory.push(roundName); // ì „ë¶€ ë¨¹ì—ˆìœ¼ë©´ "1ì°¨"
                } else if (myItems.length > 0) {
                    // ì¼ë¶€ë§Œ ë¨¹ì—ˆìœ¼ë©´ "2ì°¨(ë©œë¡  ì™¸ 1ê±´)"
                    let itemNames = myItems.map(i => i.iName);
                    let detailStr = itemNames[0];
                    if (itemNames.length > 1) detailStr += ` ì™¸ ${itemNames.length - 1}ê±´`;
                    myHistory.push(`${roundName}(${detailStr})`);
                }
            });
            memberDetails[m.name] = myHistory.join(", ");
        });

        // ê¸ˆì•¡ í° ìˆœì„œëŒ€ë¡œ ì •ë ¬ ë° ì¹´ë“œ ìƒì„±
        let sortedAmounts = Object.keys(groups).sort((a, b) => b - a);

        sortedAmounts.forEach(amt => {
            let members = groups[amt];
            let price = parseInt(amt);
            if (price === 0) return; 

            let card = document.createElement('div');
            card.className = 'card';

            let namesHtml = members.join(', ');
            let desc = memberDetails[members[0]] || "ë‚´ì—­ ì—†ìŒ";

            // [ì¶”ê°€] 1ì¸ë‹¹ ê¸ˆì•¡ í‘œì‹œ
            let perPersonHtml = '';
            if (members.length > 1) {
                perPersonHtml = `<div class="per-person">${members.length}ëª… / 1ì¸ ${price.toLocaleString()}ì›</div>`;
            }

            // í† ìŠ¤ ì†¡ê¸ˆ ë§í¬
            let tossLink = `toss://send?amount=${price}&msg=${encodeURIComponent(data.title)}`;

            card.innerHTML = `
                <div class="names">${namesHtml}</div>
                <div class="details-text">
                    <span class="details-highlight">ì°¸ì—¬:</span> ${desc}
                </div>
                <div class="price-row">
                    <div class="price-info">
                        <div class="total-price">${(price * members.length).toLocaleString()}ì›</div>
                        ${perPersonHtml}
                    </div>
                    <a href="${tossLink}" class="send-btn">ì†¡ê¸ˆ</a>
                </div>
            `;
            container.appendChild(card);
        });

        // í•˜ë‹¨ ì „ì²´ ì˜ìˆ˜ì¦ ë‚´ì—­
        let detailsDiv = document.createElement('div');
        detailsDiv.className = 'receipt-details';
        detailsDiv.innerHTML = `<div class="receipt-title">ğŸ“‹ ì „ì²´ ìƒì„¸ ì§€ì¶œ ë‚´ì—­</div>`;
        
        data.details.forEach(r => {
            detailsDiv.innerHTML += `<div style="font-weight:bold; margin-top:10px; font-size:13px;">${r.rName}</div>`;
            r.items.forEach(i => {
                detailsDiv.innerHTML += `
                    <div class="receipt-row">
                        <span>- ${i.iName}</span>
                        <span>${i.price.toLocaleString()}ì›</span>
                    </div>`;
            });
        });
        container.appendChild(detailsDiv);
    }
</script>
</body>
</html>
