<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Split ì •ì‚°</title>
    <style>
        body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; background-color: #f2f4f6; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .receipt { background: white; width: 100%; max-width: 400px; padding: 30px 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h2 { margin: 0; color: #333; font-size: 20px; text-align: center; }
        .total-price { font-size: 36px; font-weight: bold; color: #3182f6; margin: 10px 0 30px 0; text-align: center; }
        
        .bank-box { background: #f9f9f9; padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 20px; color: #555; font-weight: 500; font-size: 15px; }
        .bank-box span { display: block; font-size: 13px; color: #888; margin-bottom: 5px; }

        .section-title { font-size: 14px; color: #888; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        /* ë©¤ë²„ ë¦¬ìŠ¤íŠ¸: ë¬´ì¡°ê±´ í•œ ëª…ì”© ì¶œë ¥ */
        .member-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f5f5f5; cursor: pointer; }
        .member-row:active { background-color: #f0f0f0; }
        .member-name { font-size: 16px; font-weight: 500; color: #333; }
        .member-amt { font-size: 16px; font-weight: bold; color: #3182f6; display: flex; align-items: center; }
        .arrow { font-size: 12px; margin-left: 5px; color: #ccc; }

        /* ìƒì„¸ ë‚´ì—­ ìŠ¤íƒ€ì¼ */
        .details-container { margin-top: 30px; background: #fafafa; padding: 15px; border-radius: 12px; }
        .round-title { font-weight: bold; font-size: 15px; color: #333; margin-top: 15px; margin-bottom: 5px; }
        .round-title:first-child { margin-top: 0; }
        .item-row { display: flex; justify-content: space-between; font-size: 14px; color: #666; margin-bottom: 3px; }

        .footer { margin-top: 30px; font-size: 12px; color: #aaa; text-align: center; }
        .loading { text-align: center; color: #888; margin-top: 50px; }
    </style>
</head>
<body>

<div class="receipt">
    <h2 id="receipt-title">ë¡œë”© ì¤‘...</h2>
    <div class="total-price" id="receipt-total"></div>

    <div id="bank-area" class="bank-box" style="display:none;">
        <span>ì…ê¸ˆ ê³„ì¢Œ</span>
        <div id="bank-text"></div>
    </div>

    <div class="section-title">ë©¤ë²„ë³„ ì •ì‚° ê¸ˆì•¡ (ì´ë¦„ì„ ëˆ„ë¥´ë©´ í† ìŠ¤ ì†¡ê¸ˆ)</div>
    <div id="list-container">
        <div class="loading">ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</div>
    </div>

    <div id="details-area" class="details-container" style="display:none;">
        <div class="section-title" style="border:none; padding:0; margin-bottom:10px;">ğŸ§¾ ìƒì„¸ ì§€ì¶œ ë‚´ì—­</div>
        <div id="details-list"></div>
    </div>

    <div class="footer">Smart Split</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="./js/firebase-config.js"></script>

<script>
    const db = initFirebase(); 
    const params = new URLSearchParams(window.location.search);
    const docId = params.get('id');

    if (docId) {
        db.collection("receipts").doc(docId).get().then((doc) => {
            if (doc.exists) {
                renderReceipt(doc.data());
            } else {
                alert("ì‚­ì œëœ ì˜ìˆ˜ì¦ì…ë‹ˆë‹¤.");
            }
        });
    } else {
        document.getElementById('receipt-title').innerText = "ì˜ëª»ëœ ì ‘ê·¼";
    }

    function renderReceipt(data) {
        document.getElementById('receipt-title').innerText = data.title;
        document.getElementById('receipt-total').innerText = Number(data.total).toLocaleString() + "ì›";

        // [1] ê³„ì¢Œ ì •ë³´ í‘œì‹œ
        if (data.bank && data.bank.trim() !== "") {
            document.getElementById('bank-area').style.display = 'block';
            document.getElementById('bank-text').innerText = data.bank;
        } else {
            document.getElementById('bank-area').style.display = 'block';
            document.getElementById('bank-text').innerText = "ë“±ë¡ëœ ê³„ì¢Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
        }

        // [2] ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ (í•œ ëª…ì”© ì „ë¶€ ì¶œë ¥ - "ì™¸ Nëª…" ì—†ìŒ)
        const container = document.getElementById('list-container');
        container.innerHTML = ""; 
        
        // ê¸ˆì•¡ í° ìˆœì„œëŒ€ë¡œ ì •ë ¬í•´ì„œ ë³´ì—¬ì£¼ê¸°
        data.members.sort((a, b) => b.amount - a.amount);

        data.members.forEach(member => {
            if(member.amount === 0) return; // 0ì›ì¸ ì‚¬ëŒì€ ìƒëµ (í•„ìš”í•˜ë©´ ì£¼ì„ í•´ì œ)

            const div = document.createElement('div');
            div.className = 'member-row';
            div.innerHTML = `
                <span class="member-name">${member.name}</span>
                <span class="member-amt">
                    ${Number(member.amount).toLocaleString()}ì› 
                    <span class="arrow">></span>
                </span>
            `;
            
            // í† ìŠ¤ ì†¡ê¸ˆ ë§í¬
            div.onclick = function() {
                const tossUrl = `supertoss://send?amount=${member.amount}&msg=${data.title}`;
                location.href = tossUrl;
            };
            container.appendChild(div);
        });

        // [3] ìƒì„¸ ë‚´ì—­ í‘œì‹œ (ì˜ìˆ˜ì¦ì²˜ëŸ¼)
        if (data.details && data.details.length > 0) {
            document.getElementById('details-area').style.display = 'block';
            const detailsList = document.getElementById('details-list');
            
            data.details.forEach(round => {
                const roundBox = document.createElement('div');
                roundBox.innerHTML = `<div class="round-title">ğŸ“ ${round.rName}</div>`;
                
                if(round.items) {
                    round.items.forEach(item => {
                        const row = document.createElement('div');
                        row.className = 'item-row';
                        row.innerHTML = `
                            <span>- ${item.iName}</span>
                            <span>${Number(item.price).toLocaleString()}</span>
                        `;
                        roundBox.appendChild(row);
                    });
                }
                detailsList.appendChild(roundBox);
            });
        }
    }
</script>

</body>
</html>
