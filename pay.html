<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Split ì •ì‚°</title>
    <style>
        body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; background-color: #f2f4f6; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .receipt { background: white; width: 100%; max-width: 400px; padding: 30px 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; }
        h2 { margin: 0 0 5px 0; color: #333; font-size: 18px; }
        .total-price { font-size: 32px; font-weight: bold; color: #3182f6; margin-bottom: 30px; }
        .list-container { text-align: left; border-top: 1px solid #eee; padding-top: 20px; }
        .member-btn { display: flex; justify-content: space-between; align-items: center; padding: 15px 10px; border-bottom: 1px solid #f5f5f5; cursor: pointer; transition: background 0.2s; border-radius: 12px; }
        .member-btn:active { background-color: #f0f0f0; }
        .member-name { font-size: 16px; font-weight: 500; color: #333; }
        .member-amt { font-size: 16px; font-weight: bold; color: #3182f6; }
        .footer { margin-top: 30px; font-size: 12px; color: #888; }
        .loading { color: #888; font-size: 14px; margin-top: 50px; }
    </style>
</head>
<body>

<div class="receipt">
    <h2 id="receipt-title">ì˜ìˆ˜ì¦ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h2>
    <div class="total-price" id="receipt-total"></div>
    <div id="list-container" class="list-container">
        <div class="loading">ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...<br>(ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)</div>
    </div>
    <div class="footer">ğŸ“¢ Smart Split ì•± ë‹¤ìš´ë¡œë“œ (ê´‘ê³ )</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script src="./js/firebase-config.js?v=2.0"></script>

<script>
    const db = initFirebase(); 
    const params = new URLSearchParams(window.location.search);
    const docId = params.get('id');

    if (docId) {
        db.collection("receipts").doc(docId).get().then((doc) => {
            if (doc.exists) {
                const data = doc.data();
                renderReceipt(data);
            } else {
                showError("ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ì‚­ì œëœ ì˜ìˆ˜ì¦ì…ë‹ˆë‹¤.");
            }
        }).catch((error) => {
            console.error("Error:", error);
            showError("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        });
    } else {
        showError("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. (ID ì—†ìŒ)");
    }

    function renderReceipt(data) {
        document.getElementById('receipt-title').innerText = data.title;
        document.getElementById('receipt-total').innerText = Number(data.total).toLocaleString() + "ì›";

        const container = document.getElementById('list-container');
        container.innerHTML = ""; 

        // 1. ìƒì„¸ ë‚´ì—­ í‘œì‹œ (ìƒˆë¡œ ì¶”ê°€ëœ ê¸°ëŠ¥)
        if (data.details) {
            const detailBox = document.createElement('div');
            detailBox.style.cssText = "background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:20px; font-size:14px; color:#555; white-space: pre-wrap; line-height: 1.6;";
            detailBox.innerText = "[ìƒì„¸ ë‚´ì—­]\n" + data.details;
            container.appendChild(detailBox);
        }

        // 2. ë©¤ë²„ ê·¸ë£¹í™” ë¡œì§ (ê¸ˆì•¡ ê°™ì€ ì‚¬ëŒë¼ë¦¬ ë¬¶ê¸°)
        const grouped = {};
        data.members.forEach(m => {
            const amt = m.amount;
            if (!grouped[amt]) grouped[amt] = [];
            grouped[amt].push(m.name);
        });

        // íŒíŠ¸ ë©”ì‹œì§€ (ê³„ì¢Œ ì •ë³´ ìœ ë¬´ì— ë”°ë¼ ë‹¤ë¥´ê²Œ í‘œì‹œ)
        const hint = document.createElement('div');
        hint.style.cssText = "font-size:13px; color:#666; margin-bottom:10px; text-align:center;";
        
        if(data.bank && data.account) {
            hint.innerText = `ğŸ‘‡ ë‚´ ì´ë¦„ì„ ëˆ„ë¥´ë©´ [${data.bank}]ë¡œ ìë™ ì…ë ¥ë©ë‹ˆë‹¤`;
        } else {
            hint.innerText = "ğŸ‘‡ ë‚´ ì´ë¦„ì„ ëˆ„ë¥´ë©´ í† ìŠ¤ë¡œ ì—°ê²°ë©ë‹ˆë‹¤ (ê³„ì¢Œ ì •ë³´ ì—†ìŒ)";
        }
        container.appendChild(hint);

        // 3. ê·¸ë£¹ë³„ ë²„íŠ¼ ìƒì„±
        for (const [amount, names] of Object.entries(grouped)) {
            const btn = document.createElement('div');
            btn.className = 'member-btn';
            
            // ì´ë¦„ í‘œì‹œ (ë„ˆë¬´ ê¸¸ë©´ 'ì™¸ Nëª…' ì²˜ë¦¬)
            const nameStr = names.join(", ");
            const displayAmt = Number(amount).toLocaleString();

            let leftText = nameStr;
            if (names.length > 3) {
                leftText = `${names[0]}, ${names[1]} ì™¸ ${names.length - 2}ëª…`;
            }

            let rightText = "";
            if (names.length > 1) {
                rightText = `ê° ${displayAmt}ì› >`;
            } else {
                rightText = `${displayAmt}ì› >`;
            }

            btn.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:flex-start;">
                    <span class="member-name" style="word-break: break-all;">${leftText}</span>
                </div>
                <span class="member-amt" style="min-width: 90px; text-align:right;">${rightText}</span>
            `;
            
            // í´ë¦­ ì´ë²¤íŠ¸: í† ìŠ¤ ì†¡ê¸ˆ (ê³„ì¢Œ ì •ë³´ í¬í•¨)
            btn.onclick = function() {
                let tossUrl = `supertoss://send?amount=${amount}&msg=${data.title}`;
                
                // ê³„ì¢Œ ì •ë³´ê°€ ìˆìœ¼ë©´ URLì— ì¶”ê°€
                if (data.bank && data.account) {
                    tossUrl += `&bank=${data.bank}&accountNo=${data.account}`;
                }
                
                location.href = tossUrl;
            };
            container.appendChild(btn);
        }
    }

    function showError(msg) {
        document.getElementById('receipt-title').innerText = "ì˜¤ë¥˜";
        document.getElementById('list-container').innerHTML = `<div class="loading" style="color:red;">${msg}</div>`;
    }
</script>

</body>
</html>
