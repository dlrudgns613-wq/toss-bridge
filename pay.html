<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ì‚° ìƒì„¸ ë‚´ì—­</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <style>
        body { background-color: #F2F4F6; font-family: 'Noto Sans KR', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px 10px; }
        .container { width: 100%; max-width: 420px; }

        /* ìš”ì•½ ì¹´ë“œ */
        .summary-card { background-color: #FFF; border-radius: 16px; padding: 30px 24px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .meeting-title { font-size: 20px; font-weight: 700; color: #191F28; margin-bottom: 4px; }
        .meeting-date { font-size: 13px; color: #8B95A1; }
        .total-amount { font-size: 21px; font-weight: 700; color: #333D4B; margin-top: 16px; font-family: 'Roboto Mono', monospace; }

        .account-box { display: flex; align-items: center; justify-content: center; background-color: #F9FAFB; padding: 10px 14px; border-radius: 8px; margin-top: 20px; font-size: 13px; color: #4E5968; }
        .btn-copy { background: none; border: 1px solid #D1D6DB; border-radius: 4px; padding: 2px 8px; margin-left: 8px; font-size: 11px; color: #4E5968; cursor: pointer; }

        /* ê·¸ë£¹ ì¹´ë“œ */
        .group-card { background-color: #FFF; border-radius: 12px; padding: 20px; margin-bottom: 12px; border: 1px solid #E5E8EB; }
        .group-names { font-size: 16px; font-weight: 700; color: #191F28; margin-bottom: 8px; line-height: 1.4; }

        /* íƒœê·¸ */
        .tags-container { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
        .round-tag { background-color: #F2F4F6; color: #555; font-size: 12px; padding: 4px 8px; border-radius: 6px; font-weight: 500; }
        .round-tag.excluded { background-color: #FFF0F0; color: #E94848; text-decoration: line-through; opacity: 0.6; }
        .round-tag.alcohol { background-color: #FFF8E1; color: #F57F17; }
        .round-tag.detail { background-color: #E8F3FF; color: #3182F6; }

        .action-row { display: flex; justify-content: space-between; align-items: center; border-top: 1px dashed #F2F4F6; padding-top: 12px; margin-top: 10px; }
        .price-text { font-size: 14px; color: #333; font-weight: 500; }
        .price-text strong { color: #3182F6; font-size: 17px; font-weight: 700; font-family: 'Roboto Mono', monospace; margin-left: 4px; }
        .btn-send { background-color: #E8F3FF; color: #3182F6; padding: 7px 14px; border-radius: 6px; text-decoration: none; font-size: 13px; font-weight: 700; }

        .receipt-detail { margin-top: 40px; background-color: #FFF; padding: 25px 20px; position: relative; background-image: linear-gradient(135deg, #f2f4f6 25%, transparent 25%), linear-gradient(225deg, #f2f4f6 25%, transparent 25%); background-position: top center; background-size: 20px 20px; background-repeat: repeat-x; padding-top: 40px; }
        .detail-header { text-align: center; font-size: 13px; font-weight: 700; color: #999; margin-bottom: 20px; letter-spacing: 1px; }
        .receipt-row { display: flex; justify-content: space-between; font-size: 13px; color: #555; margin-bottom: 6px; border-bottom: 1px dotted #EEE; padding-bottom: 4px; }
        .round-header { font-weight: bold; color: #333; margin: 15px 0 5px 0; font-size: 13px; }

        .loading { text-align: center; padding: 50px; color: #888; font-size: 14px; }
        .error-msg { text-align: center; padding: 50px; color: #E94848; font-weight: bold; font-size: 14px; }
        
        /* â˜… ë°ì´í„° ì§„ë‹¨ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .debug-panel { margin-top: 50px; background-color: #222; color: #0f0; padding: 15px; font-family: monospace; font-size: 11px; width: 100%; border-radius: 8px; word-break: break-all; }
        .debug-title { color: #fff; font-weight: bold; border-bottom: 1px solid #555; padding-bottom: 5px; margin-bottom: 5px; }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 10px; position: fixed; z-index: 99; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 13px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div class="container" id="receiptArea">
        <div class="loading">ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
    
    <div id="debugArea" class="container"></div>

    <div id="toast">ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.</div>

    <script>
        if (typeof initFirebase !== 'function') {
            document.getElementById('receiptArea').innerHTML = `<div class="error-msg">âš ï¸ ì„¤ì • íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨ (js/firebase-config.js)</div>`;
            throw new Error("Config not loaded");
        }

        const db = initFirebase();
        const urlParams = new URLSearchParams(window.location.search);
        const docId = urlParams.get('id');

        if (docId) loadReceipt(docId);
        else document.getElementById('receiptArea').innerHTML = "<div class='loading'>ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.</div>";

        function loadReceipt(id) {
            db.collection("receipts").doc(id).get().then((doc) => {
                if (doc.exists) {
                    renderPage(doc.data());
                    renderDebugInfo(doc.data()); // â˜… ì§„ë‹¨ ì‹¤í–‰
                } else {
                    document.getElementById('receiptArea').innerHTML = "<div class='loading'>ì‚­ì œëœ ì˜ìˆ˜ì¦ì…ë‹ˆë‹¤.</div>";
                }
            }).catch((e) => {
                document.getElementById('receiptArea').innerHTML = "<div class='loading'>ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨<br>" + e.message + "</div>";
            });
        }

        function renderPage(data) {
            const normalize = (str) => (str || "").replace(/\s/g, "").toLowerCase();

            // 1. ê·¸ë£¹í•‘ (Ver 15.0 ë¡œì§ ìœ ì§€)
            let groups = {};

            data.members.forEach(member => {
                if (member.amount === 0) return;
                
                let myName = normalize(member.name);
                let mySignature = []; 
                let myTagsData = [];

                if (data.details && Array.isArray(data.details)) {
                    data.details.forEach((round, idx) => {
                        let title = round.rName || (idx + 1) + "ì°¨";
                        title = title.replace(/[\[\]]/g, "").replace("ë¹„ìš©", "").trim();

                        let totalItems = round.items ? round.items.length : 0;
                        let skippedItems = []; 

                        if (round.items && round.items.length > 0) {
                            round.items.forEach(item => {
                                let eatersList = item.eaters || item.participants || item.members;
                                
                                let didIEat = false;
                                if (!eatersList) {
                                    // â˜… ì—¬ê¸°ê°€ í•µì‹¬: ëª…ë‹¨ì´ ì—†ìœ¼ë©´ ë¬´ì¡°ê±´ ë¨¹ì€ ê±¸ë¡œ ì²˜ë¦¬ë¨
                                    didIEat = true; 
                                } else {
                                    didIEat = eatersList.some(e => normalize(e).includes(myName) || myName.includes(normalize(e)));
                                }

                                if (!didIEat) {
                                    let iName = item.iName || item.name || "ë©”ë‰´";
                                    skippedItems.push(iName);
                                }
                            });
                        } else {
                            totalItems = 1; 
                        }

                        // íƒœê·¸ í…ìŠ¤íŠ¸ ìƒì„±
                        let tagText = title;
                        let tagType = "FULL";

                        if (skippedItems.length === 0) {
                            tagType = "FULL";
                        } else if (skippedItems.length === totalItems) {
                            tagText += "(ë¯¸ì°¸ì—¬)";
                            tagType = "EXCLUDED";
                        } else {
                            let allSkippedIsAlcohol = skippedItems.every(name => {
                                return name.toLowerCase().match(/ìˆ |ì†Œì£¼|ë§¥ì£¼|ì£¼ë¥˜|í•˜ì´ë³¼|ì§„ë¡œ|ì¹´ìŠ¤|í…Œë¼|ìƒˆë¡œ|ì²­í•˜|ë§‰ê±¸ë¦¬|ì°¸ì´ìŠ¬|ì²˜ìŒì²˜ëŸ¼|ë³µë¶„ì/);
                            });

                            if (allSkippedIsAlcohol && skippedItems.length > 0) {
                                tagText += "(ìˆ  ì œì™¸)";
                                tagType = "ALCOHOL";
                            } else {
                                let detailStr = "";
                                if (skippedItems.length > 2) {
                                    detailStr = `${skippedItems[0]}, ${skippedItems[1]} ì™¸`;
                                } else {
                                    detailStr = skippedItems.join(", ");
                                }
                                tagText += `(${detailStr} ì œì™¸)`;
                                tagType = "DETAIL";
                            }
                        }

                        mySignature.push(`${idx}:${tagText}`);
                        myTagsData.push({ text: tagText, type: tagType });
                    });
                }

                let groupKey = `${member.amount}_${mySignature.join("|")}`;
                if (!groups[groupKey]) {
                    groups[groupKey] = { amount: member.amount, members: [], tagsData: myTagsData };
                }
                groups[groupKey].members.push(member.name);
            });

            // HTML ê·¸ë¦¬ê¸°
            let html = `
                <div class="summary-card">
                    <div class="meeting-title">${data.title}</div>
                    <div class="meeting-date">${data.date}</div>
                    <div class="total-amount">Total â‚©${Number(data.total).toLocaleString()}</div>
                    <div class="account-box">
                        <span>${data.bankName || "ì€í–‰"} ${data.accountNumber || ""}</span>
                        <button class="btn-copy" onclick="copyAccount('${data.accountNumber}')">ë³µì‚¬</button>
                    </div>
                </div>
            `;

            let sortedKeys = Object.keys(groups).sort((a, b) => groups[b].amount - groups[a].amount);

            sortedKeys.forEach(key => {
                let group = groups[key];
                let names = group.members.join(", ");
                let count = group.members.length;
                let perPerson = Number(group.amount).toLocaleString();
                
                let tagsHtml = "";
                group.tagsData.forEach(tag => {
                    let badgeClass = "round-tag";
                    if (tag.type === "EXCLUDED") badgeClass += " excluded";
                    else if (tag.type === "ALCOHOL") badgeClass += " alcohol";
                    else if (tag.type === "DETAIL") badgeClass += " detail";
                    
                    tagsHtml += `<span class="${badgeClass}">${tag.text}</span>`;
                });

                let priceLabel = count > 1 ? `1ì¸ë‹¹ <strong>${perPerson}ì›</strong>` : `<strong>${perPerson}ì›</strong>`;
                let bankParam = data.bankName ? `&bank=${data.bankName}` : "";
                let accountParam = data.accountNumber ? `&accountNo=${data.accountNumber}` : "";
                let tossLink = `supertoss://send?amount=${group.amount}${bankParam}${accountParam}`;

                html += `
                    <div class="group-card">
                        <div class="group-names">${names} <span style="font-weight:400; font-size:13px; color:#888;">(${count}ëª…)</span></div>
                        <div class="tags-container">${tagsHtml}</div>
                        <div class="action-row">
                            <div class="price-text">${priceLabel}</div>
                            <a href="${tossLink}" class="btn-send">ì†¡ê¸ˆí•˜ê¸°</a>
                        </div>
                    </div>
                `;
            });

            html += `
                <div class="receipt-detail">
                    <div class="detail-header">â”€â”€ ìƒì„¸ ì˜ìˆ˜ì¦ (RECEIPT) â”€â”€</div>
            `;
            if (data.details) {
                data.details.forEach(round => {
                    let rTitle = round.rName.replace("ë¹„ìš©", "").trim();
                    html += `<div class="round-header">[ ${rTitle} ]</div>`;
                    if(round.items) {
                        round.items.forEach(item => {
                            html += `
                                <div class="receipt-row">
                                    <span>${item.iName || item.name}</span>
                                    <span>${Number(item.price).toLocaleString()}</span>
                                </div>`;
                        });
                    }
                });
            }
            html += `<div style="text-align:center; margin-top:10px; font-size:11px; color:#AAA;">Smart Split Ver 16.0</div></div>`;

            document.getElementById('receiptArea').innerHTML = html;
        }

        // â˜…â˜…â˜… ë°ì´í„° ì§„ë‹¨ í•¨ìˆ˜ â˜…â˜…â˜…
        function renderDebugInfo(data) {
            let debugHtml = `<div class="debug-panel"><div class="debug-title">ğŸ” DEBUG INFO (ê°œë°œì í™•ì¸ìš©)</div>`;
            
            if (data.details) {
                data.details.forEach((round, idx) => {
                    debugHtml += `<div>[${idx+1}ì°¨] ${round.rName}</div>`;
                    if (round.items) {
                        round.items.forEach(item => {
                            let eaters = item.eaters || item.participants || item.members;
                            let status = eaters ? JSON.stringify(eaters) : "<span style='color:red'>DATA MISSING (NULL)</span>";
                            debugHtml += `<div style="padding-left:10px;">- ${item.iName || item.name}: ${status}</div>`;
                        });
                    } else {
                        debugHtml += `<div style="padding-left:10px; color:red">- ì•„ì´í…œ ì •ë³´ ì—†ìŒ</div>`;
                    }
                    debugHtml += `<br>`;
                });
            } else {
                debugHtml += `<div>ìƒì„¸ ë‚´ì—­(details) ë°ì´í„° ì—†ìŒ</div>`;
            }
            debugHtml += `</div>`;
            
            document.getElementById('debugArea').innerHTML = debugHtml;
        }

        function copyAccount(acc) {
            if(!acc) return;
            navigator.clipboard.writeText(acc).then(() => {
                let x = document.getElementById("toast");
                x.className = "show";
                setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
            });
        }
    </script>
</body>
</html>
